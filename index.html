<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Trah Sukata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- FamilyTree.js dari jsdelivr -->
  <script src="https://cdn.jsdelivr.net/npm/@balkangraph/familytree.js@latest/familytree.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #tree { width: 100vw; height: 100vh; }
    .ft-menu-row {
      margin-bottom: 5px;
    }
    .ft-menu-label {
      font-weight: bold;
      width: 120px;
      display: inline-block;
    }
    .ft-menu-value {
      display: inline-block;
    }
  </style>
</head>
<body>
  <div id="tree"></div>
  <script>
    // Ganti dengan link endpoint kamu
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbyZZl2h8OBb2buS5Qv-3oumCNtC4e9xGHGRa0A6jGJ3Dq6BU8U5QblYnK7nRBz-_WNhVQ/exec";

    // Peta gender
    const genderMap = {
      "M": "Laki-laki",
      "F": "Perempuan",
      "Laki-laki": "Laki-laki",
      "Perempuan": "Perempuan"
    };

    function showDetailModal(d) {
      const infoHtml = `
        <div class="ft-menu-row"><span class="ft-menu-label">Nama Lengkap:</span> <span class="ft-menu-value">${d.nama_lengkap || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Nama Panggilan:</span> <span class="ft-menu-value">${d.nama_panggilan || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Gender:</span> <span class="ft-menu-value">${d.gender ? (genderMap[d.gender] || d.gender) : "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Domisili:</span> <span class="ft-menu-value">${d.domisili || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Tahun Lahir:</span> <span class="ft-menu-value">${d.tahun_lahir || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Usia Saat Ini:</span> <span class="ft-menu-value">${d.usia_saat_ini || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Tahun Wafat:</span> <span class="ft-menu-value">${d.tahun_wafat || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Usia Saat Wafat:</span> <span class="ft-menu-value">${d.usia_saat_wafat || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Nama Bapak:</span> <span class="ft-menu-value">${d.nama_bapak || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Nama Ibu:</span> <span class="ft-menu-value">${d.nama_ibu || "-"}</span></div>
        <div class="ft-menu-row"><span class="ft-menu-label">Nama Pasangan:</span> <span class="ft-menu-value">${d.nama_pasangan || "-"}</span></div>
      `;
      FamilyTree.menu.showModal({
        title: "Detail Anggota Keluarga",
        html: infoHtml
      });
    }

    fetch(ENDPOINT)
      .then(res => res.json())
      .then(data => {
        const nodes = data.map(item => {
          const displayName = (item.nama_panggilan && item.nama_panggilan.trim() !== "") ? item.nama_panggilan : item.nama_lengkap;
          const genderFT = (item.gender === "F" || item.gender === "Perempuan") ? "female" : "male";
          return {
            id: item.id,
            pids: item.sid ? [item.sid] : [],
            fid: item.fid || null,
            mid: item.mid || null,
            name: displayName,
            gender: genderFT,
            data: {
              nama_lengkap: item.nama_lengkap,
              nama_panggilan: item.nama_panggilan,
              gender: item.gender,
              domisili: item.domisili_terakhir,
              tahun_lahir: item.tahun_lahir,
              usia_saat_ini: item.usia_saat_ini,
              tahun_wafat: item.tahun_wafat,
              usia_saat_wafat: item.usia_saat_wafat,
              nama_bapak: item.nama_bapak,
              nama_ibu: item.nama_ibu,
              nama_pasangan: item.pasangan
            }
          };
        });

        const family = new FamilyTree(document.getElementById("tree"), {
          template: "john",
          mode: "light",
          nodeBinding: {
            field_0: "name"
          },
          nodeMenu: {
            details: { text: "Detail Anggota" }
          },
          onNodeMenuClick: function(sender, args) {
            if(args.menuItem === "details") {
              showDetailModal(args.node.data);
            }
          },
          onClick: function(sender, args) {
            // Hanya tampilkan detail jika klik pada node (bukan background atau pan)
            if (args && args.node) {
              showDetailModal(args.node.data);
            }
          }
        });

        family.load(nodes);
      })
      .catch(err => {
        document.getElementById("tree").innerHTML = "<b>Gagal memuat data keluarga.<br>Periksa koneksi atau endpoint.</b>";
        console.error(err);
      });
  </script>
</body>
</html>
